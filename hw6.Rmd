---
title: "Homework 6"
author: "Vincent Tam"
date: "November 25, 2018"
output: github_document
---

```{r setup}
library(tidyverse)
library(janitor)
library(dplyr)
library(purrr)
hom_data <- read.csv(file = "./homicide-data.csv") 
hom_data = 
  hom_data %>%
  mutate(city_state = str_c(city, ",", state)) %>%
  filter(city_state != "Dallas,TX", city_state != "Phoenix,AZ", city_state != "Kansas City,MO", city_state != "Tulsa,AL") %>% 
  filter(victim_sex != "Unknown") %>%
  mutate(victim_sex = as.factor(victim_sex)) %>%
  mutate(victim_race = recode(victim_race, 'White' = "White", 'Hispanic' = "Non_white", 'Other' = "Non_white", 'Black' = "Non_white", 'Asian' = "Non_white", 'Unknown' = "Non_white")) %>% 
  mutate(solved = as.numeric(disposition == "Closed by arrest"),
         victim_age = as.numeric(victim_age),
         victim_race = fct_relevel(victim_race, "White", "Non_white")) %>% 
  mutate(victim_age = as.numeric(victim_age)) 
baltimore_data = 
  hom_data %>%
  filter(city_state == "Baltimore,MD")
baltimore_fit = 
  baltimore_data %>% 
  glm(solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(OR = boot::inv.logit(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value) %>% 
  knitr::kable(digits = 3)
cities_glinmodel = 
  hom_data %>% 
  group_by(city_state) %>%
  select(city_state, solved, victim_age, victim_race, victim_sex) %>%
  nest() %>% 
  mutate(glinmodel = map(data, ~glm(solved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()))) %>%
  mutate(glinmodel_tidy = map(glinmodel, ~broom::tidy(.))) %>%
  mutate(glinmodel_ci = map(glinmodel, ~broom::confint_tidy(.))) %>%
  select(city_state, glinmodel_tidy, glinmodel_ci) %>% 
  unnest() %>% 
  mutate(OR = exp(estimate)) %>%
  mutate(conf.low = exp(estimate - (1.96 * std.error)), conf.high = exp(estimate + (1.96 * std.error))) 
cities_plot =
  cities_glinmodel %>% 
  ggplot(aes(fct_reorder(city_state, OR), OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  labs(
    title = "Estimates and CIs for All Cities",
    x = "City",
    y = "Estimates"
  )  +
  theme(axis.text.x = element_text(angle = 90))
cities_plot
```
### Problem 2
```{r}
birthweight = read.csv(file = "./birthweight.csv")
birthweight_data = 
  birthweight %>%
  mutate(babysex = as.factor(babysex), frace = as.factor(frace), malform = as.factor(malform), 
         mrace = as.factor(mrace))
mod_maternalfactors = 
  birthweight_data %>%
  select(bwt, ppbmi, ppwt)
lm_maternalfactors = lm(bwt ~ ppbmi + ppwt, mod_maternalfactors)
lm_maternalfactors %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)
modelr::add_residuals(mod_maternalfactors, lm_maternalfactors)
modelr::add_predictions(mod_maternalfactors, lm_maternalfactors)
mod_maternalfactors %>% 
  modelr::add_residuals(lm_maternalfactors) %>% 
  ggplot(aes(x = ppbmi + ppwt, y = resid)) + geom_violin()
birthweight_data %>%
  modelr::add_predictions(lm_maternalfactors) %>%
  modelr::add_residuals(lm_maternalfactors) %>%
  ggplot(aes(x = pred, y = resid)) + geom_point()
## One using length at birth and gestational age as predictors (main effects only)
## One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```

